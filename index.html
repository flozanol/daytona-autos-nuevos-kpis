// Función para generar tabla de agencia individual
function generateSingleAgencyTable() {
    if (!singleSelectedAgency) {
        alert('Por favor selecciona una agencia');
        return;
    }
    
    if (singleSelectedMonths.length === 0) {
        alert('Por favor selecciona al menos un mes');
        return;
    }
    
    const agency = loadedData.find(a => a.agency === singleSelectedAgency);
    if (!agency) {
        alert('Agencia no encontrada');
        return;
    }
    
    const singleTableHeader = document.getElementById('singleTableHeader');
    const singleTableBody = document.getElementById('singleTableBody');
    const container = document.getElementById('singleAgencyTableContainer');
    
    // Mostrar container
    container.classList.remove('hidden');
    
    // Crear encabezados (agregar Promedio y Tendencia)
    const headers = ['KPI', ...singleSelectedMonths, 'Promedio', 'Tendencia'];
    singleTableHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join('');
    
    // Crear filas con formateo y resaltado
    const rows = agency.kpis.map(kpi => {
        const row = [kpi.name];
        const rowValues = [];
        
        // Agregar valores de meses
        singleSelectedMonths.forEach(month => {
            const value = kpi[month];
            row.push(value);
            rowValues.push(value);
        });
        
        // Calcular promedio
        const validValues = rowValues.filter(val => val !== null && val !== undefined && val !== 'N/A' && !isNaN(val));
        const average = validValues.length > 0 ? validValues.reduce((sum, val) => sum + val, 0) / validValues.length : 0;
        
        // Calcular tendencia
        const trendAnalysis = calculateTrend(rowValues);
        
        // Agregar promedio y tendencia a la fila
        row.push(average);
        row.push(trendAnalysis);
        
        // Encontrar el valor más alto de esta fila (solo para los meses, no promedio)
        const highestValue = findHighestValue(rowValues);
        
        return { data: row, rowValues: rowValues, highest: highestValue, average: average, trend: trendAnalysis };
    });
    
    // Renderizar filas con formateo y resaltado
    singleTableBody.innerHTML = rows.map(rowObj => {
        const formattedCells = rowObj.data.map((cell, index) => {
            if (index === 0) {
                // Primera columna (KPI name)
                return `<td>${cell}</td>`;
            } else if (index === rowObj.data.length - 2) {
                // Columna de promedio
                const formattedAverage = formatNumber(rowObj.average);
                return `<td class="font-semibold text-yellow-400">${formattedAverage}</td>`;
            } else if (index === rowObj.data.length - 1) {
                // Columna de tendencia
                const trend = rowObj.trend;
                return `<td class="${trend.color}"><i class="${trend.icon} mr-2"></i>${trend.trend}</td>`;
            } else {
                // Columnas de datos de meses
                const rawValue = rowObj.rowValues[index - 1];
                const isHighest = rawValue !== 'N/A' && rawValue === rowObj.highest && rowObj.highest !== null;
                const formattedValue = formatNumber(cell);
                const cssClass = isHighest ? 'highest-value' : '';
                
                return `<td class="${cssClass}">${formattedValue}</td>`;
            }
        }).join('');
        
        return `<tr>${formattedCells}</tr>`;
    }).join('');
    
    showStatus('success', `Tabla individual generada para ${singleSelectedAgency}`);
}

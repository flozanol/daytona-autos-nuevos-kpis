<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard KPIs Autos Nuevos - Grupo Daytona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
        }

        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-start infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(239, 68, 68, 0.5); border-radius: 3px; }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        table { border-collapse: separate; border-spacing: 0; table-layout: auto; }
        th, td { border: 1px solid rgba(255, 255, 255, 0.1); padding: 8px 10px; text-align: center; white-space: nowrap; }
        th { background: rgba(255, 255, 255, 0.1); color: white; font-weight: 600; position: sticky; top: 0; z-index: 20; }
        
        #tableBody td:first-child, #tableHeader th:first-child,
        #singleAgencyTable #singleTableBody td:first-child, #singleAgencyTable #singleTableHeader th:first-child {
            position: sticky; left: 0; background: rgba(15, 23, 42, 0.9); z-index: 15; border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        #tableHeader th:first-child, #singleAgencyTable #singleTableHeader th:first-child { z-index: 25; }

        td { color: rgba(255, 255, 255, 0.9); font-size: 0.75rem; }
        tr:nth-child(even) { background: rgba(255, 255, 255, 0.02); }
        tr:hover { background: rgba(255, 255, 255, 0.05); }
        
        .highest-value { background: rgba(34, 197, 94, 0.2) !important; color: #22c55e !important; font-weight: 600; border: 1px solid rgba(34, 197, 94, 0.3) !important; }
        .tendencia-roja { color: #ef4444 !important; font-weight: 600; }
        .tendencia-amarilla { color: #f59e0b !important; font-weight: 600; }
        .tendencia-verde { color: #22c55e !important; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen">
    <nav class="glass-effect border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://api.grupodaytona.com/files/images/full-xzLxpZqXUE-1728519042236.png" alt="Grupo Daytona" class="w-10 h-10 rounded-lg object-contain bg-white/10 p-1">
                    <div>
                        <h1 class="text-xl font-bold text-white">Grupo Daytona</h1>
                        <p class="text-sm text-gray-300">Dashboard KPIs Autos Nuevos - Cierre Anual</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="hidden md:flex items-center space-x-2 text-gray-300">
                        <i class="fas fa-clock text-sm"></i>
                        <span class="text-sm" id="currentTime"></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="text-center mb-12">
            <h2 class="text-5xl font-bold gradient-text mb-4">
                Análisis Gerencial Autos Nuevos
            </h2>
            <p class="text-xl text-gray-300 max-w-2xl mx-auto leading-relaxed">
                Revisión de resultados, tendencias y proyecciones
            </p>
        </div>

        <div class="flex justify-center space-x-6 mb-12">
            <button onclick="loadDemo()" class="btn-primary px-8 py-4 rounded-xl text-white font-semibold text-lg shadow-2xl">
                <i class="fas fa-play mr-3"></i> Cargar Demo
            </button>
            <button onclick="connectToAPI()" class="btn-secondary px-8 py-4 rounded-xl text-white font-semibold text-lg shadow-2xl">
                <i class="fas fa-link mr-3 animated-icon"></i> Conectar API
            </button>
        </div>

        <div id="status" class="hidden mb-8">
            <div class="glass-effect rounded-xl p-4 border-l-4">
                <div class="flex items-center">
                    <i id="statusIcon" class="text-2xl mr-3"></i>
                    <p id="statusText" class="text-lg font-medium text-white"></p>
                </div>
            </div>
        </div>

        <div id="results" class="hidden">
            
            <div class="glass-effect ai-card rounded-2xl p-6 mb-8 transform transition-all hover:scale-[1.01]">
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="fas fa-robot text-white text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-white mb-2 flex items-center">
                            Daytona AI Insights
                            <span class="ml-2 text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full border border-purple-500/30">BETA</span>
                        </h3>
                        <div class="bg-black/20 rounded-xl p-4 border border-white/5 min-h-[80px]">
                            <p id="aiNarrativeText" class="text-gray-200 text-sm leading-relaxed font-mono typing-cursor">
                                Esperando datos para generar análisis inteligente...
                            </p>
                        </div>
                        <div class="mt-2 flex justify-end">
                            <span class="text-xs text-gray-400"><i class="fas fa-bolt text-yellow-500 mr-1"></i>Análisis generado en tiempo real</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-building text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalAgencies">0</h3>
                    <p class="text-gray-300 font-medium">Agencias Analizadas</p>
                </div>
                
                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-calendar-check text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalPeriods">0</h3>
                    <p class="text-gray-300 font-medium">Meses en Revisión</p>
                </div>

                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-car-side text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalVolumeDisplay">0</h3>
                    <p class="text-gray-300 font-medium">Unidades Totales (Período)</p>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-6 mb-8">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleConfig()">
                    <h3 class="text-lg font-bold text-white flex items-center">
                        <i class="fas fa-filter mr-2 text-gray-400"></i> Filtros y Configuración
                    </h3>
                    <i class="fas fa-chevron-down text-white" id="configChevron"></i>
                </div>
                
                <div id="configPanel" class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-8 hidden">
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-semibold text-white">Agencias (<span id="agencyCount">0</span>)</label>
                            <div class="space-x-2">
                                <button onclick="selectAllAgencies()" class="text-xs text-green-400 hover:text-green-300">Todas</button>
                                <button onclick="deselectAllAgencies()" class="text-xs text-red-400 hover:text-red-300">Ninguna</button>
                            </div>
                        </div>
                        <div class="max-h-40 overflow-y-auto bg-black/20 rounded-lg p-3 scrollbar-thin">
                            <div id="agencyCheckboxes" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <label class="text-sm font-semibold text-white">Meses (<span id="monthCount">0</span>)</label>
                        <div class="max-h-40 overflow-y-auto bg-black/20 rounded-lg p-3 scrollbar-thin">
                            <div id="monthCheckboxes" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="col-span-1 lg:col-span-2 flex justify-center mt-2">
                        <button onclick="updateAnalysis()" class="btn-primary px-12 py-3 rounded-xl text-white font-semibold">
                            <i class="fas fa-sync-alt mr-2"></i> Generar Reporte
                        </button>
                    </div>
                </div>
            </div>

            <div id="advancedChartsContainer" class="hidden mb-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-bold text-white"><i class="fas fa-water mr-2 text-blue-400"></i>Evolución Mensual (Waterfall)</h4>
                    </div>
                    <div id="waterfallChart" style="width: 100%; height: 350px;"></div>
                    <p class="text-xs text-gray-400 mt-2 text-center">Variación neta mes contra mes del total del grupo.</p>
                </div>

                <div class="glass-effect rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-bold text-white"><i class="fas fa-trophy mr-2 text-yellow-400"></i>Ranking Acumulado</h4>
                    </div>
                    <div id="rankingChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-8 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-white">Matriz de KPIs</h3>
                    <button onclick="exportMainTableToExcel()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30 transition-all">
                        <i class="fas fa-file-excel mr-2"></i> Excel
                    </button>
                </div>
                <div class="overflow-x-auto overflow-y-auto max-h-[500px] bg-white/5 border border-white/10 rounded-xl scrollbar-thin">
                    <table class="min-w-full text-xs">
                        <thead><tr id="tableHeader"></tr></thead>
                        <tbody id="tableBody" class="divide-y divide-white/10"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="glass-effect rounded-2xl p-8 mb-8">
                <h3 class="text-2xl font-bold text-white mb-6">Deep Dive por Agencia</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">Agencia</label>
                        <select id="singleAgencySelect" onchange="updateSingleAgencyMonths()" class="w-full p-3 bg-black/30 border border-white/20 rounded-xl text-white outline-none focus:border-blue-500"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-gray-400 text-sm mb-2 block">Meses a comparar (<span id="singleMonthCount">0</span>)</label>
                        <div class="bg-black/20 p-3 rounded-xl border border-white/10 h-[52px] overflow-hidden hover:overflow-y-auto relative scrollbar-thin">
                            <div id="singleMonthCheckboxes" class="flex flex-wrap gap-4"></div>
                        </div>
                    </div>
                </div>
                <button onclick="generateSingleAgencyTable()" class="btn-primary w-full py-3 rounded-xl text-white font-semibold mb-6">
                    Analizar Agencia
                </button>
                
                <div id="singleAgencyTableContainer" class="hidden">
                    <div class="overflow-auto max-h-96 bg-white/5 border border-white/10 rounded-xl scrollbar-thin mb-8">
                        <table id="singleAgencyTable" class="min-w-full text-sm">
                            <thead><tr id="singleTableHeader"></tr></thead>
                            <tbody id="singleTableBody" class="divide-y divide-white/10"></tbody>
                        </table>
                    </div>
                    <div id="lineChartContainer" class="mt-8">
                        <h4 class="text-lg font-bold text-white mb-4">Tendencia de Facturación</h4>
                        <canvas id="unidadesFacturadasLineChart" class="max-h-80 w-full"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <footer class="mt-16 text-center text-gray-500 text-sm pb-8">
            <p>© 2025 Grupo Daytona | Powered by Data Intelligence</p>
        </footer>
    </div>

<script>
// --- CONFIGURACIÓN Y VARIABLES GLOBALES ---
let loadedData = [];
let selectedAgencies = [];
let selectedMonths = [];
let allKPIs = [];
let allMonths = [];
let singleSelectedAgency = '';
let singleSelectedMonths = [];

// API Configuration
const API_KEY = "AIzaSyATBI8jMV1AtfsjhmwEwfOMYSdKmhMM5ck"; 
const SPREADSHEET_ID = "1xzQYs3KOIINVTTvVOYSQDiuiQDUsCWwqEDoQAUvBNfQ";
const KPI_UNIDADES_FACTURADAS = 'Unidades Facturadas'; 
const chronologicalMonthOrder = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

// Instancias de Gráficos
let unidadesFacturadasLineChart = null;
let waterfallChartInstance = null;
let rankingChartInstance = null;

// --- UTILITIES ---
function formatNumber(value) {
    if (value === null || value === undefined || value === 'N/A') return 'N/A';
    const num = typeof value === 'string' ? parseFloat(value) : value;
    if (isNaN(num)) return 'N/A';
    return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Sin decimales para autos
}

function updateClock() {
    const now = new Date();
    const el = document.getElementById('currentTime');
    if(el) el.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
}
setInterval(updateClock, 60000);
updateClock();

function toggleConfig() {
    const panel = document.getElementById('configPanel');
    const chevron = document.getElementById('configChevron');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-up');
    } else {
        panel.classList.add('hidden');
        chevron.classList.remove('fa-chevron-up');
        chevron.classList.add('fa-chevron-down');
    }
}

// --- CORE LOGIC: API & DATA ---

async function connectToAPI() {
    showStatus('loading', 'Conectando con Google Sheets...');
    try {
        const metadataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?key=${API_KEY}`);
        if (!metadataResponse.ok) throw new Error('Error de conexión con Google');
        
        const metadata = await metadataResponse.json();
        const sheets = metadata.sheets || [];
        // Filtro simple para encontrar hojas relevantes
        const validSheets = sheets.map(s => s.properties.title).filter(title => 
            ['Honda', 'KIA', 'MG', 'GWM', 'Acura', 'Seat', 'Cupra', 'Mazda', 'Suzuki'].some(brand => title.includes(brand))
        );

        if (validSheets.length === 0) throw new Error('No se encontraron hojas de agencias');

        const loadedAgencies = [];
        
        for (const sheetName of validSheets) {
            const dataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName + '!A:Z')}?key=${API_KEY}`);
            const sheetData = await dataResponse.json();
            if (sheetData.values && sheetData.values.length > 1) {
                const processed = processRealSheetData(sheetData.values, sheetName);
                if (processed) loadedAgencies.push(processed);
            }
        }

        if (loadedAgencies.length > 0) {
            loadedData = loadedAgencies;
            displayResults(loadedData);
            showStatus('success', `${loadedAgencies.length} agencias cargadas.`);
        } else {
            throw new Error('Datos vacíos o formato incorrecto');
        }

    } catch (error) {
        console.error(error);
        showStatus('error', 'Error API: Carga la demo por favor.');
    }
}

function processRealSheetData(values, agencyName) {
    try {
        const headers = values[0];
        let kpiIndex = headers.findIndex(h => h.toLowerCase().includes('kpi') || h.toLowerCase().includes('concepto'));
        if (kpiIndex === -1) kpiIndex = 0;

        const monthColumns = [];
        headers.forEach((h, i) => {
            if (i !== kpiIndex && typeof h === 'string') {
                const match = chronologicalMonthOrder.find(m => h.toLowerCase().startsWith(m.toLowerCase().substring(0,3)));
                if (match) monthColumns.push({ index: i, month: match });
            }
        });

        const kpis = [];
        const availableMonths = monthColumns.map(m => m.month).sort((a,b) => chronologicalMonthOrder.indexOf(a) - chronologicalMonthOrder.indexOf(b));

        values.slice(1).forEach(row => {
            const kpiName = row[kpiIndex];
            if (kpiName) {
                const kpiObj = { name: kpiName.trim() };
                monthColumns.forEach(col => {
                    let val = row[col.index];
                    if (typeof val === 'string') val = parseFloat(val.replace(/,/g, '').replace(/[^0-9.-]+/g,""));
                    kpiObj[col.month] = isNaN(val) ? 0 : val;
                });
                kpis.push(kpiObj);
            }
        });

        return { agency: agencyName, kpis: kpis, months: availableMonths };
    } catch (e) {
        console.error('Error parsing sheet', agencyName, e);
        return null;
    }
}

function loadDemo() {
    showStatus('loading', 'Generando simulación...');
    // Datos simulados para demostración
    const agencies = ['Honda Cuajimalpa', 'Honda Interlomas', 'KIA Interlomas', 'MG Iztapalapa', 'GWM Morelos', 'Acura Interlomas'];
    const kpis = [KPI_UNIDADES_FACTURADAS, 'Ventas Brutas', 'Leads Digitales', 'Test Drives', 'Solicitudes Crédito'];
    const months = chronologicalMonthOrder.slice(0, 11); // Hasta Noviembre

    const data = agencies.map(agency => {
        const agencyKpis = kpis.map(kpiName => {
            const kpiObj = { name: kpiName };
            let base = kpiName === KPI_UNIDADES_FACTURADAS ? 50 : 200;
            months.forEach((m, i) => {
                // Simular estacionalidad y crecimiento
                let factor = 1 + (Math.random() * 0.4 - 0.2); 
                if (i > 6) factor += 0.1; // Mejor cierre de año
                kpiObj[m] = Math.round(base * factor);
            });
            return kpiObj;
        });
        return { agency: agency, kpis: agencyKpis, months: months };
    });

    loadedData = data;
    displayResults(data);
    showStatus('success', 'Demo cargada exitosamente.');
}

function displayResults(data) {
    document.getElementById('results').classList.remove('hidden');
    allKPIs = [...new Set(data.flatMap(d => d.kpis.map(k => k.name)))];
    allMonths = [...new Set(data.flatMap(d => d.months))].sort((a,b) => chronologicalMonthOrder.indexOf(a) - chronologicalMonthOrder.indexOf(b));
    
    // Selectores
    const agencySelect = document.getElementById('singleAgencySelect');
    agencySelect.innerHTML = '<option value="">Seleccionar...</option>';
    data.map(d => d.agency).sort().forEach(a => {
        agencySelect.innerHTML += `<option value="${a}">${a}</option>`;
    });

    // Filtros Iniciales (Seleccionar todos por defecto)
    selectedAgencies = data.map(d => d.agency);
    selectedMonths = [...allMonths];
    
    refreshFiltersUI();
    updateAnalysis(); // Generar reporte inicial
}

function refreshFiltersUI() {
    populateCheckboxes('agencyCheckboxes', loadedData.map(d => d.agency).sort(), selectedAgencies, 'agency');
    populateCheckboxes('monthCheckboxes', allMonths, selectedMonths, 'month');
    updateCounts();
}

function populateCheckboxes(id, items, selected, type) {
    const container = document.getElementById(id);
    container.innerHTML = '';
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'flex items-center hover:bg-white/5 p-1 rounded';
        div.innerHTML = `
            <input type="checkbox" id="${type}-${item}" value="${item}" class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-600" ${selected.includes(item) ? 'checked' : ''}>
            <label for="${type}-${item}" class="ml-2 text-sm text-gray-200 cursor-pointer w-full">${item}</label>
        `;
        div.querySelector('input').addEventListener('change', (e) => {
            if (e.target.checked) selected.push(item);
            else { const idx = selected.indexOf(item); if (idx > -1) selected.splice(idx, 1); }
            updateCounts();
        });
        container.appendChild(div);
    });
}

function updateCounts() {
    document.getElementById('agencyCount').innerText = selectedAgencies.length;
    document.getElementById('monthCount').innerText = selectedMonths.length;
}

function selectAllAgencies() { selectedAgencies = loadedData.map(d => d.agency); refreshFiltersUI(); }
function deselectAllAgencies() { selectedAgencies = []; refreshFiltersUI(); }

// --- MAIN ANALYSIS & CHARTS ---

function updateAnalysis() {
    if (selectedAgencies.length === 0 || selectedMonths.length === 0) {
        showStatus('error', 'Selecciona datos para el reporte.');
        return;
    }

    // Ordenar cronológicamente meses seleccionados
    const sortedMonths = selectedMonths.sort((a,b) => chronologicalMonthOrder.indexOf(a) - chronologicalMonthOrder.indexOf(b));
    
    // 1. Generate Main Table
    generateMainTable(sortedMonths);

    // 2. Generate Waterfall Chart (ECharts)
    updateWaterfallChart(sortedMonths);

    // 3. Generate Ranking Chart (ECharts)
    updateRankingChart(sortedMonths);

    // 4. Generate AI Narrative
    generateAINarrative(sortedMonths);

    // Update Top Stats
    document.getElementById('totalAgencies').innerText = selectedAgencies.length;
    document.getElementById('totalPeriods').innerText = sortedMonths.length;
    
    // Ocultar configuración tras generar
    document.getElementById('configPanel').classList.add('hidden');
    document.getElementById('configChevron').className = 'fas fa-chevron-down text-white';
    document.getElementById('advancedChartsContainer').classList.remove('hidden');
}

function generateMainTable(months) {
    const thead = document.getElementById('tableHeader');
    const tbody = document.getElementById('tableBody');
    thead.innerHTML = ''; tbody.innerHTML = '';

    // Headers
    const headers = ['KPI', ...selectedAgencies.sort(), 'Total Grupo', 'Tendencia'];
    headers.forEach(h => {
        const th = document.createElement('th');
        th.innerText = h;
        if(h === 'Total Grupo') th.classList.add('bg-blue-900/50');
        thead.appendChild(th);
    });

    allKPIs.forEach(kpi => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="text-left font-medium text-white">${kpi}</td>`;
        
        let rowSum = 0;
        let rowCounts = 0;

        selectedAgencies.forEach(agency => {
            const data = loadedData.find(d => d.agency === agency);
            const kpiData = data.kpis.find(k => k.name === kpi);
            
            let val = 0;
            if (kpiData) {
                // Sum or Avg depending on logic (Sum for now)
                months.forEach(m => val += (kpiData[m] || 0));
            }
            rowSum += val;
            
            const td = document.createElement('td');
            td.innerText = formatNumber(val);
            tr.appendChild(td);
        });

        // Total Grupo
        const tdTotal = document.createElement('td');
        tdTotal.innerText = formatNumber(rowSum);
        tdTotal.className = 'bg-blue-900/20 font-bold';
        tr.appendChild(tdTotal);

        // Tendencia (Simple slope comparison: First selected month vs Last selected month group total)
        // This calculates if the group grew from start to end of period
        let startVal = 0, endVal = 0;
        selectedAgencies.forEach(a => {
            const d = loadedData.find(da => da.agency === a).kpis.find(k => k.name === kpi);
            if(d) {
                startVal += (d[months[0]] || 0);
                endVal += (d[months[months.length-1]] || 0);
            }
        });

        const tdTrend = document.createElement('td');
        if (startVal > 0) {
            const change = ((endVal - startVal) / startVal) * 100;
            tdTrend.innerHTML = `<span class="${change >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">${change > 0 ? '+' : ''}${change.toFixed(1)}%</span>`;
        } else {
            tdTrend.innerText = '-';
        }
        tr.appendChild(tdTrend);

        tbody.appendChild(tr);
    });
}

// --- ECHARTS: WATERFALL CHART (EL EXPERTO) ---
function updateWaterfallChart(months) {
    const chartDom = document.getElementById('waterfallChart');
    if (waterfallChartInstance) waterfallChartInstance.dispose();
    waterfallChartInstance = echarts.init(chartDom, 'dark');

    // Preparar datos: Total del Grupo mes a mes
    const monthlyTotals = months.map(m => {
        let sum = 0;
        selectedAgencies.forEach(a => {
            const data = loadedData.find(d => d.agency === a);
            const kpi = data.kpis.find(k => k.name === KPI_UNIDADES_FACTURADAS);
            if(kpi) sum += (kpi[m] || 0);
        });
        return sum;
    });

    // Lógica Waterfall: Calcular deltas
    const data = [];
    const help = []; // Barra transparente base
    let currentPos = 0;

    months.forEach((m, i) => {
        if (i === 0) {
            // Primer mes es base
            help.push(0);
            data.push(monthlyTotals[i]);
            currentPos = monthlyTotals[i];
        } else {
            const diff = monthlyTotals[i] - monthlyTotals[i-1];
            if (diff >= 0) {
                help.push(currentPos);
                data.push(diff);
                currentPos += diff;
            } else {
                currentPos += diff; // diff es negativo
                help.push(currentPos);
                data.push(Math.abs(diff));
            }
        }
    });

    // Agregar total final como última columna
    const labels = [...months];
    
    // Colores dinámicos
    const itemStyle = {
        color: (params) => {
            const idx = params.dataIndex;
            if (idx === 0) return '#5470C6'; // Azul inicio
            const val = monthlyTotals[idx] - monthlyTotals[idx-1];
            return val >= 0 ? '#10B981' : '#EF4444'; // Verde sube, Rojo baja
        }
    };

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: function (params) {
                const tar = params[1]; // La barra visible
                const monthName = params[0].name;
                const idx = params[0].dataIndex;
                const total = monthlyTotals[idx];
                return `${monthName}<br/>Variación: ${tar.value}<br/>Total Grupo: ${total}`;
            }
        },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'category', splitLine: { show: false }, data: labels },
        yAxis: { type: 'value' },
        series: [
            {
                name: 'Base',
                type: 'bar',
                stack: 'Total',
                itemStyle: { borderColor: 'transparent', color: 'transparent' },
                emphasis: { itemStyle: { borderColor: 'transparent', color: 'transparent' } },
                data: help
            },
            {
                name: 'Variación',
                type: 'bar',
                stack: 'Total',
                label: { show: true, position: 'top' },
                itemStyle: itemStyle,
                data: data
            }
        ]
    };

    waterfallChartInstance.setOption(option);
    
    // Actualizar KPI total en tarjeta
    const totalPeriodVolume = monthlyTotals.reduce((a,b) => a + b, 0); // Ojo: esto suma todos los totales mensuales, quizás queremos el último acumulado o la suma de facturación.
    // Para unidades facturadas en un periodo, es la suma de todos los meses.
    document.getElementById('totalVolumeDisplay').innerText = formatNumber(totalPeriodVolume);
}

// --- ECHARTS: RANKING CHART ---
function updateRankingChart(months) {
    const chartDom = document.getElementById('rankingChart');
    if (rankingChartInstance) rankingChartInstance.dispose();
    rankingChartInstance = echarts.init(chartDom, 'dark');

    // Calcular total por agencia en el periodo seleccionado
    const rankingData = selectedAgencies.map(a => {
        const data = loadedData.find(d => d.agency === a);
        const kpi = data.kpis.find(k => k.name === KPI_UNIDADES_FACTURADAS);
        let sum = 0;
        if(kpi) months.forEach(m => sum += (kpi[m] || 0));
        return { name: a, value: sum };
    }).sort((a,b) => a.value - b.value); // Orden ascendente para gráfico horizontal

    const option = {
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'value', splitLine: { show: false } },
        yAxis: { type: 'category', data: rankingData.map(d => d.name) },
        series: [
            {
                name: 'Unidades',
                type: 'bar',
                data: rankingData.map(d => d.value),
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: '#F59E0B' },
                        { offset: 1, color: '#EF4444' }
                    ])
                },
                label: { show: true, position: 'right', color: '#fff' }
            }
        ]
    };
    rankingChartInstance.setOption(option);
}

// --- AI NARRATIVE GENERATOR (MOCKUP INTELIGENTE) ---
function generateAINarrative(months) {
    const container = document.getElementById('aiNarrativeText');
    container.innerHTML = '';
    
    // 1. Análisis básico de datos para construir el prompt/texto
    let totalVol = 0;
    let bestAgency = { name: '', val: 0 };
    let worstAgency = { name: '', val: Infinity };
    
    selectedAgencies.forEach(a => {
        const data = loadedData.find(d => d.agency === a);
        const kpi = data.kpis.find(k => k.name === KPI_UNIDADES_FACTURADAS);
        let sum = 0;
        if(kpi) months.forEach(m => sum += (kpi[m] || 0));
        totalVol += sum;
        if(sum > bestAgency.val) bestAgency = { name: a, val: sum };
        if(sum < worstAgency.val) worstAgency = { name: a, val: sum };
    });

    // 2. Construcción del Texto (Narrativa)
    // NOTA: Aquí es donde conectarías con Vercel AI SDK: 
    // const response = await fetch('/api/generate-summary', { body: JSON.stringify({data}) });
    
    const narrative = `Análisis de Cierre: El Grupo Daytona consolidó ${formatNumber(totalVol)} unidades facturadas en el periodo seleccionado (${months[0]} - ${months[months.length-1]}). 
    La agencia destacada es ${bestAgency.name} aportando el ${Math.round((bestAgency.val/totalVol)*100)}% del volumen total. 
    Se observa una oportunidad de mejora en ${worstAgency.name}, que requiere revisión de inventario y leads para el próximo ciclo. 
    Tendencia general: ${totalVol > 1000 ? 'Positiva y Estable' : 'En proceso de consolidación'}.`;

    // 3. Efecto de "Escribiendo"
    let i = 0;
    const speed = 20; 
    function typeWriter() {
        if (i < narrative.length) {
            container.innerHTML += narrative.charAt(i);
            i++;
            setTimeout(typeWriter, speed);
        } else {
            container.classList.remove('typing-cursor');
        }
    }
    typeWriter();
}

// --- SINGLE AGENCY LOGIC (EXISTENTE, PEQUEÑOS AJUSTES VISUALES) ---
function updateSingleAgencyMonths() {
    singleSelectedAgency = document.getElementById('singleAgencySelect').value;
    const container = document.getElementById('singleMonthCheckboxes');
    container.innerHTML = '';
    
    if(!singleSelectedAgency) return;
    
    const data = loadedData.find(d => d.agency === singleSelectedAgency);
    if(data) {
        // Generar checkboxes
        data.months.sort((a,b) => chronologicalMonthOrder.indexOf(a) - chronologicalMonthOrder.indexOf(b))
            .forEach(m => {
                const div = document.createElement('div');
                div.innerHTML = `<input type="checkbox" checked value="${m}" class="mr-1"> ${m}`;
                div.className = 'text-white text-sm flex items-center bg-white/10 px-2 py-1 rounded';
                div.querySelector('input').addEventListener('change', (e) => {
                     // Lógica simple para demo, en producción usar arrays globales
                });
                container.appendChild(div);
            });
        singleSelectedMonths = data.months; // Auto-select all
        document.getElementById('singleMonthCount').innerText = singleSelectedMonths.length;
    }
}

function generateSingleAgencyTable() {
    // Reutilizar lógica existente visualmente
    const tableDiv = document.getElementById('singleAgencyTableContainer');
    tableDiv.classList.remove('hidden');
    
    if (!singleSelectedAgency) return;
    
    const data = loadedData.find(d => d.agency === singleSelectedAgency);
    const kpi = data.kpis.find(k => k.name === KPI_UNIDADES_FACTURADAS);
    
    // Render Line Chart (Chart.js)
    const ctx = document.getElementById('unidadesFacturadasLineChart').getContext('2d');
    if (unidadesFacturadasLineChart) unidadesFacturadasLineChart.destroy();
    
    const values = singleSelectedMonths.map(m => kpi ? (kpi[m] || 0) : 0);
    
    unidadesFacturadasLineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: singleSelectedMonths,
            datasets: [{
                label: 'Unidades',
                data: values,
                borderColor: '#60A5FA',
                backgroundColor: 'rgba(96, 165, 250, 0.2)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#aaa' } },
                x: { grid: { display: false }, ticks: { color: '#aaa' } }
            }
        }
    });

    // Populate table (Simplified for this full code replacement)
    const thead = document.getElementById('singleTableHeader');
    const tbody = document.getElementById('singleTableBody');
    thead.innerHTML = `<th>KPI</th>${singleSelectedMonths.map(m => `<th>${m}</th>`).join('')}`;
    tbody.innerHTML = '';
    
    data.kpis.forEach(k => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="text-left font-medium">${k.name}</td>` + 
                       singleSelectedMonths.map(m => `<td>${formatNumber(k[m])}</td>`).join('');
        tbody.appendChild(tr);
    });
}

function exportMainTableToExcel() {
    const table = document.getElementById('tableBody');
    if(table.rows.length === 0) return alert('Genera el reporte primero');
    // Implementación simplificada usando la librería ya cargada
    const wb = XLSX.utils.table_to_book(document.querySelector("table"), {sheet: "KPIs"});
    XLSX.writeFile(wb, "Reporte_Daytona_AutosNuevos.xlsx");
}

function showStatus(type, msg) {
    const el = document.getElementById('status');
    const txt = document.getElementById('statusText');
    const icon = document.getElementById('statusIcon');
    el.classList.remove('hidden');
    txt.innerText = msg;
    // Reset icons logic (simplified)
    icon.className = type === 'loading' ? 'fas fa-spinner fa-spin text-blue-500' : 
                     type === 'success' ? 'fas fa-check text-green-500' : 'fas fa-exclamation text-red-500';
}

</script>
</body>
</html>

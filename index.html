<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Gerencial - Grupo Daytona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); }
        .glass-effect { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(135deg, #60A5FA, #A78BFA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-primary { background: linear-gradient(135deg, #3B82F6, #2563EB); transition: 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3); }
        
        /* AI Card Styles */
        .ai-card { background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%); border: 1px solid rgba(139, 92, 246, 0.3); }
        .typing-cursor::after { content: '|'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Tablas */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { border: 1px solid rgba(255,255,255,0.1); padding: 12px 15px; text-align: center; white-space: nowrap; font-size: 0.85rem; color: #e2e8f0; }
        th { background: rgba(15, 23, 42, 0.95); position: sticky; top: 0; z-index: 20; color: #93c5fd; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        /* Primera columna fija */
        td:first-child, th:first-child { position: sticky; left: 0; background: rgba(15, 23, 42, 0.95); z-index: 15; text-align: left; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.1); }
        th:first-child { z-index: 25; }
        
        /* Semáforos y Utilidades */
        .trend-up { color: #4ade80; font-weight: bold; }
        .trend-down { color: #f87171; font-weight: bold; }
        .trend-neutral { color: #fbbf24; font-weight: bold; }
        .highest-val { background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.4); color: #4ade80; font-weight: bold; }
        .avg-col { background: rgba(59, 130, 246, 0.1); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen text-white">

    <nav class="glass-effect border-b border-white/10 sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <img src="https://api.grupodaytona.com/files/images/full-xzLxpZqXUE-1728519042236.png" class="w-8 h-8 object-contain">
            <div>
                <h1 class="text-lg font-bold">Grupo Daytona</h1>
                <p class="text-xs text-gray-400">Dashboard Gerencial 360°</p>
            </div>
        </div>
        <div class="text-sm text-gray-400 font-mono" id="clock">--:--</div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h2 class="text-4xl font-bold gradient-text">Análisis de Resultados</h2>
                <p class="text-gray-400 mt-1">Comparativas Anuales, Mensuales y Detalle por Agencia</p>
            </div>
            <div class="flex gap-3">
                <button onclick="loadDemo()" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-lg text-sm font-medium transition-all">
                    <i class="fas fa-play mr-2"></i>Demo
                </button>
                <button onclick="connectToAPI()" class="btn-primary px-6 py-2 rounded-lg text-sm font-medium">
                    <i class="fas fa-database mr-2"></i>Conectar API
                </button>
            </div>
        </div>

        <div id="status" class="hidden mb-6 p-4 rounded-lg bg-blue-500/10 border border-blue-500/20 text-blue-200 text-sm"></div>

        <div id="dashboardContent" class="hidden space-y-12">

            <div class="glass-effect ai-card rounded-2xl p-6 transform transition-all hover:scale-[1.01] shadow-2xl shadow-indigo-500/10">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="fas fa-robot text-white text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-white flex items-center">
                                Daytona AI Insights
                                <span class="ml-2 text-[10px] bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full border border-purple-500/30 font-mono">BETA</span>
                            </h3>
                            <span class="text-xs text-gray-400"><i class="fas fa-bolt text-yellow-500 mr-1"></i>Análisis en tiempo real</span>
                        </div>
                        <div class="bg-black/30 rounded-xl p-4 border border-white/5 min-h-[60px]">
                            <p id="aiNarrativeText" class="text-gray-200 text-sm leading-relaxed font-mono typing-cursor">
                                Analizando datos de ventas...
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-effect p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="document.getElementById('filtersPanel').classList.toggle('hidden')">
                    <h3 class="text-lg font-semibold flex items-center gap-2"><i class="fas fa-filter text-blue-400"></i> Filtros Globales</h3>
                    <i class="fas fa-chevron-down text-gray-400"></i>
                </div>
                <div id="filtersPanel" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden"> <div>
                        <label class="text-xs text-gray-400 uppercase tracking-wider font-bold mb-2 block">Agencias</label>
                        <div class="flex gap-2 mb-2">
                            <button onclick="toggleAll('agency', true)" class="text-xs text-green-400 hover:underline">Todas</button>
                            <button onclick="toggleAll('agency', false)" class="text-xs text-red-400 hover:underline">Ninguna</button>
                        </div>
                        <div id="agencyChecks" class="bg-black/20 p-3 rounded-lg max-h-40 overflow-y-auto scrollbar-thin grid grid-cols-2 gap-2 text-sm"></div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase tracking-wider font-bold mb-2 block">Meses (Para Acumulados)</label>
                        <div class="flex gap-2 mb-2">
                            <button onclick="toggleAll('month', true)" class="text-xs text-green-400 hover:underline">Todos</button>
                            <button onclick="toggleAll('month', false)" class="text-xs text-red-400 hover:underline">Ninguno</button>
                        </div>
                        <div id="monthChecks" class="bg-black/20 p-3 rounded-lg max-h-40 overflow-y-auto scrollbar-thin grid grid-cols-3 gap-2 text-sm"></div>
                    </div>
                    <button onclick="updateAllTables()" class="md:col-span-2 btn-primary py-2 rounded-lg font-bold">Aplicar Filtros</button>
                </div>
            </div>

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="bg-blue-500 w-1 h-8 rounded-full"></span>
                    <h3 class="text-2xl font-bold">1. Resumen Global (Acumulado)</h3>
                </div>
                
                <div class="flex flex-col gap-6">
                    
                    <div class="glass-effect p-6 rounded-2xl">
                        <h4 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Variación Mensual Total Grupo</h4>
                        <div id="waterfallChart" style="height: 350px; width: 100%;"></div>
                    </div>

                    <div class="glass-effect p-6 rounded-2xl overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Matriz de KPIs Acumulados</h4>
                            <button onclick="exportTable('globalTable')" class="text-xs bg-green-500/20 text-green-400 px-3 py-1 rounded hover:bg-green-500/30 transition-all"><i class="fas fa-file-excel mr-1"></i>Exportar Excel</button>
                        </div>
                        <div class="overflow-auto scrollbar-thin">
                            <table id="globalTable">
                                <thead id="globalThead"></thead>
                                <tbody id="globalTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="bg-purple-500 w-1 h-8 rounded-full"></span>
                    <h3 class="text-2xl font-bold">2. Comparativo Mensual</h3>
                </div>
                <div class="glass-effect p-6 rounded-2xl">
                    <div class="flex flex-col md:flex-row gap-4 items-center mb-6 bg-black/20 p-4 rounded-xl border border-white/5">
                        <label class="text-sm font-bold text-purple-300 whitespace-nowrap">Selecciona el Mes a Analizar:</label>
                        <select id="compareMonthSelect" onchange="updateMonthlyComparison()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-white outline-none focus:border-purple-500 w-full md:w-64 cursor-pointer hover:bg-gray-700 transition-colors">
                            </select>
                        <div class="text-xs text-gray-400 ml-auto hidden md:block">
                            <i class="fas fa-info-circle mr-1"></i> Compara todas las agencias activas en el mes seleccionado.
                        </div>
                    </div>

                    <div class="overflow-auto scrollbar-thin max-h-[600px]">
                        <table id="monthlyTable">
                            <thead id="monthlyThead"></thead>
                            <tbody id="monthlyTbody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="bg-orange-500 w-1 h-8 rounded-full"></span>
                    <h3 class="text-2xl font-bold">3. Histórico por Agencia</h3>
                </div>
                <div class="glass-effect p-6 rounded-2xl">
                    <div class="flex flex-col md:flex-row gap-4 items-center mb-6 bg-black/20 p-4 rounded-xl border border-white/5">
                        <label class="text-sm font-bold text-orange-300 whitespace-nowrap">Selecciona Agencia:</label>
                        <select id="historyAgencySelect" onchange="updateAgencyHistory()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-white outline-none focus:border-orange-500 w-full md:w-64 cursor-pointer hover:bg-gray-700 transition-colors">
                            </select>
                    </div>

                    <div class="flex flex-col gap-6">
                        
                        <div class="bg-black/20 p-6 rounded-xl border border-white/5">
                            <h4 class="text-sm font-bold text-gray-400 mb-4 text-center uppercase tracking-wider">Tendencia: Unidades Facturadas</h4>
                            <div style="height: 300px; width: 100%;">
                                <canvas id="historyChart"></canvas>
                            </div>
                        </div>

                        <div class="overflow-auto scrollbar-thin max-h-[600px] border border-white/10 rounded-xl">
                            <table id="historyTable">
                                <thead id="historyThead"></thead>
                                <tbody id="historyTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

        </div>
        
        <footer class="mt-12 text-center text-gray-500 text-xs py-8 border-t border-white/5">
            © 2025 Grupo Daytona | Business Intelligence Dashboard
        </footer>
    </div>

<script>
// --- CONFIGURACIÓN ---
const API_KEY = "AIzaSyATBI8jMV1AtfsjhmwEwfOMYSdKmhMM5ck"; 
const SPREADSHEET_ID = "1xzQYs3KOIINVTTvVOYSQDiuiQDUsCWwqEDoQAUvBNfQ";
const KPI_TARGET = 'Unidades Facturadas'; 
const MONTHS_ORDER = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

// --- ESTADO ---
let rawData = [];
let activeAgencies = [];
let activeMonths = [];
let chartInstances = {};

// --- INICIO ---
function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'}); }
setInterval(updateClock, 60000); updateClock();

// --- CARGA DE DATOS ---
async function connectToAPI() {
    uiStatus('loading', 'Conectando con Google Sheets...');
    try {
        const metaRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?key=${API_KEY}`);
        const meta = await metaRes.json();
        const sheetNames = meta.sheets.map(s => s.properties.title).filter(t => !['Resumen', 'Dashboard', 'Config'].includes(t)); 

        if (!sheetNames.length) throw new Error("No se encontraron hojas de agencias.");

        rawData = [];
        for (const name of sheetNames) {
            const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(name + '!A:Z')}?key=${API_KEY}`);
            const json = await res.json();
            if (json.values && json.values.length > 1) {
                const processed = parseSheet(json.values, name);
                if (processed) rawData.push(processed);
            }
        }
        
        initDashboard();
        uiStatus('success', `Datos cargados: ${rawData.length} agencias.`);
    } catch (e) {
        console.error(e);
        uiStatus('error', 'Error en conexión. Intenta cargar la Demo.');
    }
}

function loadDemo() {
    uiStatus('loading', 'Generando datos demo...');
    const agencies = ['Honda Cuajimalpa', 'KIA Interlomas', 'MG Iztapalapa', 'GWM Morelos', 'Acura Interlomas', 'Mazda Pasión'];
    const kpis = [KPI_TARGET, 'Ventas Brutas', 'Leads Digitales', 'Test Drives', 'Solicitudes Crédito', 'Tasa Aprobación %'];
    
    rawData = agencies.map(name => ({
        agency: name,
        kpis: kpis.map(k => {
            const row = { name: k };
            MONTHS_ORDER.forEach(m => row[m] = Math.floor(Math.random() * (k.includes('%') ? 100 : 200)));
            return row;
        })
    }));
    
    initDashboard();
    uiStatus('success', 'Modo Demo Activo');
}

function parseSheet(values, agencyName) {
    try {
        const headers = values[0].map(h => h.trim());
        let kpiIdx = headers.findIndex(h => h.toLowerCase().match(/kpi|concepto|indicador/));
        if (kpiIdx === -1) kpiIdx = 0;

        const mapMonths = {};
        headers.forEach((h, i) => {
            const match = MONTHS_ORDER.find(m => h.toLowerCase().startsWith(m.toLowerCase().substr(0,3)));
            if (match) mapMonths[match] = i;
        });

        const kpis = values.slice(1).map(row => {
            const obj = { name: row[kpiIdx] };
            if (!obj.name) return null;
            Object.keys(mapMonths).forEach(m => {
                let val = row[mapMonths[m]];
                if (typeof val === 'string') val = parseFloat(val.replace(/[^0-9.-]+/g,""));
                obj[m] = isNaN(val) ? 0 : val;
            });
            return obj;
        }).filter(k => k);

        return { agency: agencyName, kpis };
    } catch (e) { return null; }
}

// --- DASHBOARD LOGIC ---

function initDashboard() {
    document.getElementById('dashboardContent').classList.remove('hidden');
    
    activeAgencies = rawData.map(d => d.agency).sort();
    activeMonths = [...MONTHS_ORDER]; 

    renderChecks('agencyChecks', activeAgencies, 'agency');
    renderChecks('monthChecks', MONTHS_ORDER, 'month');
    
    const monthSel = document.getElementById('compareMonthSelect');
    monthSel.innerHTML = MONTHS_ORDER.map(m => `<option value="${m}">${m}</option>`).join('');
    monthSel.value = MONTHS_ORDER[new Date().getMonth()] || 'Enero'; 

    const agencySel = document.getElementById('historyAgencySelect');
    agencySel.innerHTML = activeAgencies.map(a => `<option value="${a}">${a}</option>`).join('');

    updateAllTables();
}

function updateAllTables() {
    activeAgencies = getCheckedValues('agency');
    activeMonths = getCheckedValues('month').sort((a,b) => MONTHS_ORDER.indexOf(a) - MONTHS_ORDER.indexOf(b));

    if (activeAgencies.length === 0 || activeMonths.length === 0) {
        alert("Selecciona al menos una agencia y un mes en los filtros globales.");
        return;
    }

    renderTable1_Global();
    updateMonthlyComparison(); 
    updateAgencyHistory();
    
    // Generar IA Narrative
    generateAINarrative();
}

// IA NARRATIVE GENERATOR
function generateAINarrative() {
    const container = document.getElementById('aiNarrativeText');
    container.innerHTML = '';
    
    // Calcular datos básicos para el texto
    let totalVol = 0;
    let bestAgency = { name: '', val: 0 };
    let activeKpiFound = false;

    activeAgencies.forEach(a => {
        const d = rawData.find(data => data.agency === a);
        const k = d?.kpis.find(kpi => kpi.name === KPI_TARGET);
        if(k) {
            activeKpiFound = true;
            let sum = 0;
            activeMonths.forEach(m => sum += (k[m] || 0));
            totalVol += sum;
            if (sum > bestAgency.val) bestAgency = { name: a, val: sum };
        }
    });

    if (!activeKpiFound) {
        container.innerText = "No se encontraron datos del KPI principal para generar insights.";
        return;
    }

    // Texto simulado (Prompt Logic)
    const narrative = `REPORTE EJECUTIVO (${activeMonths[0]} - ${activeMonths[activeMonths.length-1]}): 
    El Grupo Daytona acumula un total de ${fmt(totalVol)} unidades facturadas. 
    La agencia líder del periodo es ${bestAgency.name} con ${fmt(bestAgency.val)} unidades (${Math.round((bestAgency.val/totalVol)*100)}% del total). 
    Se recomienda revisar inventarios en las agencias con rendimiento inferior al promedio mensual.`;

    // Efecto de escritura
    let i = 0;
    const speed = 15; 
    function typeWriter() {
        if (i < narrative.length) {
            container.innerHTML += narrative.charAt(i);
            i++;
            setTimeout(typeWriter, speed);
        } else {
            container.classList.remove('typing-cursor');
        }
    }
    typeWriter();
}

// TABLA 1: GLOBAL
function renderTable1_Global() {
    const thead = document.getElementById('globalThead');
    const tbody = document.getElementById('globalTbody');
    thead.innerHTML = ''; tbody.innerHTML = '';

    let htmlHead = `<tr><th>KPI</th>`;
    activeAgencies.forEach(a => htmlHead += `<th>${a}</th>`);
    htmlHead += `<th class="bg-blue-900/50">Total</th><th class="bg-blue-900/50">Promedio</th><th>Tendencia</th></tr>`;
    thead.innerHTML = htmlHead;

    const allKpis = [...new Set(rawData.flatMap(d => d.kpis.map(k => k.name)))];

    allKpis.forEach(kpiName => {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${kpiName}</td>`;
        
        let rowTotal = 0;
        let validAgencies = 0;
        let startVal = 0; 
        let endVal = 0;   
        const valsForHighlight = [];

        activeAgencies.forEach((ag) => {
            const data = rawData.find(d => d.agency === ag);
            const kpiObj = data?.kpis.find(k => k.name === kpiName);
            let sum = 0;
            if (kpiObj) {
                activeMonths.forEach(m => sum += (kpiObj[m] || 0));
                startVal += (kpiObj[activeMonths[0]] || 0);
                endVal += (kpiObj[activeMonths[activeMonths.length-1]] || 0);
            }
            rowTotal += sum;
            validAgencies++;
            valsForHighlight.push(sum);
            tr.innerHTML += `<td>${fmt(sum)}</td>`;
        });

        const maxVal = Math.max(...valsForHighlight);
        Array.from(tr.children).slice(1).forEach((td, i) => {
            if (parseFloat(td.innerText.replace(/,/g,'')) === maxVal && maxVal > 0) td.classList.add('highest-val');
        });

        const avg = validAgencies ? rowTotal / validAgencies : 0;
        tr.innerHTML += `<td class="font-bold bg-blue-900/20">${fmt(rowTotal)}</td>`;
        tr.innerHTML += `<td class="font-bold bg-blue-900/20">${fmt(avg)}</td>`;

        const trend = startVal > 0 ? ((endVal - startVal) / startVal) * 100 : 0;
        const trendClass = trend > 0 ? 'trend-up' : (trend < 0 ? 'trend-down' : 'trend-neutral');
        tr.innerHTML += `<td class="${trendClass}">${trend > 0 ? '↑' : (trend < 0 ? '↓' : '-')} ${Math.abs(trend).toFixed(1)}%</td>`;

        tbody.appendChild(tr);
    });

    renderWaterfall();
}

function renderWaterfall() {
    const chartData = activeMonths.map(m => {
        let sum = 0;
        activeAgencies.forEach(a => {
            const d = rawData.find(data => data.agency === a);
            const k = d?.kpis.find(kpi => kpi.name === KPI_TARGET);
            if(k) sum += (k[m] || 0);
        });
        return sum;
    });

    const dom = document.getElementById('waterfallChart');
    if (chartInstances.waterfall) chartInstances.waterfall.dispose();
    chartInstances.waterfall = echarts.init(dom, 'dark');

    const option = {
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        grid: { left: '2%', right: '2%', top: 20, bottom: 20, containLabel:true },
        xAxis: { type: 'category', data: activeMonths },
        yAxis: { type: 'value', splitLine: { show: false } },
        series: [{
            type: 'bar',
            data: chartData,
            itemStyle: { color: '#3B82F6', borderRadius: [4, 4, 0, 0] },
            label: { show: true, position: 'top', color: '#fff' }
        }]
    };
    chartInstances.waterfall.setOption(option);
    // Resize chart on window resize
    window.addEventListener('resize', function() {
        chartInstances.waterfall.resize();
    });
}

// TABLA 2: MENSUAL
function updateMonthlyComparison() {
    const selectedMonth = document.getElementById('compareMonthSelect').value;
    const thead = document.getElementById('monthlyThead');
    const tbody = document.getElementById('monthlyTbody');
    thead.innerHTML = ''; tbody.innerHTML = '';

    let htmlHead = `<tr><th>KPI (${selectedMonth})</th>`;
    activeAgencies.forEach(a => htmlHead += `<th>${a}</th>`);
    htmlHead += `<th class="avg-col">Promedio Mes</th><th class="bg-purple-900/50">Ganador</th></tr>`;
    thead.innerHTML = htmlHead;

    const allKpis = [...new Set(rawData.flatMap(d => d.kpis.map(k => k.name)))];

    allKpis.forEach(kpiName => {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${kpiName}</td>`;
        let rowSum = 0;
        let maxVal = -Infinity;
        let winnerName = '-';
        const vals = [];

        activeAgencies.forEach(ag => {
            const data = rawData.find(d => d.agency === ag);
            const kpiObj = data?.kpis.find(k => k.name === kpiName);
            const val = kpiObj ? (kpiObj[selectedMonth] || 0) : 0;
            rowSum += val;
            vals.push(val);
            if (val > maxVal) { maxVal = val; winnerName = ag; }
            tr.innerHTML += `<td>${fmt(val)}</td>`;
        });

        Array.from(tr.children).slice(1).forEach((td, i) => {
            if (vals[i] === maxVal && maxVal > 0) td.classList.add('highest-val');
        });

        const avg = activeAgencies.length ? rowSum / activeAgencies.length : 0;
        tr.innerHTML += `<td class="avg-col font-bold">${fmt(avg)}</td>`;
        tr.innerHTML += `<td class="text-purple-300 font-bold">${maxVal > 0 ? winnerName : '-'}</td>`;
        tbody.appendChild(tr);
    });
}

// TABLA 3: HISTÓRICO
function updateAgencyHistory() {
    const selectedAgency = document.getElementById('historyAgencySelect').value;
    const thead = document.getElementById('historyThead');
    const tbody = document.getElementById('historyTbody');
    thead.innerHTML = ''; tbody.innerHTML = '';

    let htmlHead = `<tr><th>KPI</th>`;
    activeMonths.forEach(m => htmlHead += `<th>${m}</th>`);
    htmlHead += `<th class="avg-col">Promedio</th><th>Tendencia</th></tr>`;
    thead.innerHTML = htmlHead;

    const data = rawData.find(d => d.agency === selectedAgency);
    if (!data) return;

    const chartLabels = activeMonths;
    const chartValues = [];

    data.kpis.forEach(k => {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${k.name}</td>`;
        let sum = 0;
        let start = k[activeMonths[0]] || 0;
        let end = k[activeMonths[activeMonths.length-1]] || 0;

        activeMonths.forEach(m => {
            const val = k[m] || 0;
            sum += val;
            tr.innerHTML += `<td>${fmt(val)}</td>`;
            if (k.name === KPI_TARGET) chartValues.push(val);
        });

        const avg = sum / activeMonths.length;
        tr.innerHTML += `<td class="avg-col font-bold">${fmt(avg)}</td>`;
        const trend = start > 0 ? ((end - start) / start) * 100 : 0;
        const trendClass = trend > 0 ? 'trend-up' : (trend < 0 ? 'trend-down' : 'trend-neutral');
        tr.innerHTML += `<td class="${trendClass}">${trend > 0 ? '↑' : (trend < 0 ? '↓' : '-')} ${Math.abs(trend).toFixed(1)}%</td>`;
        tbody.appendChild(tr);
    });

    const ctx = document.getElementById('historyChart').getContext('2d');
    if (chartInstances.history) chartInstances.history.destroy();
    
    if (chartValues.length === 0) activeMonths.forEach(() => chartValues.push(0));

    chartInstances.history = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Unidades',
                data: chartValues,
                borderColor: '#F97316',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { display: false } }
        }
    });
}

// UTILITIES
function fmt(n) { return n.toLocaleString('en-US', {maximumFractionDigits: 1}); }
function uiStatus(type, msg) {
    const el = document.getElementById('status');
    el.classList.remove('hidden');
    el.innerHTML = type === 'loading' ? `<i class="fas fa-spinner fa-spin mr-2"></i>${msg}` : 
                   type === 'error' ? `<i class="fas fa-exclamation-triangle mr-2"></i>${msg}` : 
                   `<i class="fas fa-check mr-2"></i>${msg}`;
}
function renderChecks(id, items, type) {
    const c = document.getElementById(id);
    c.innerHTML = items.map(i => `
        <label class="flex items-center space-x-2 cursor-pointer hover:bg-white/5 p-1 rounded">
            <input type="checkbox" value="${i}" checked class="form-checkbox text-blue-500 rounded bg-gray-700 border-none" data-type="${type}">
            <span>${i}</span>
        </label>
    `).join('');
}
function getCheckedValues(type) {
    return Array.from(document.querySelectorAll(`input[data-type="${type}"]:checked`)).map(cb => cb.value);
}
function toggleAll(type, state) {
    document.querySelectorAll(`input[data-type="${type}"]`).forEach(cb => cb.checked = state);
}
function exportTable(id) {
    const wb = XLSX.utils.table_to_book(document.getElementById(id));
    XLSX.writeFile(wb, `Daytona_Export_${id}.xlsx`);
}

</script>
</body>
</html>

}
        
        console.log('üîó Usando Google Sheet ID:', SPREADSHEET_ID);
        
        // Obtener metadata del spreadsheet
        const metadataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?key=${API_KEY}`;
        console.log('üì° Consultando metadata:', metadataUrl);
        
        const metadataResponse = await fetch(metadataUrl);
        
        if (!metadataResponse.ok) {
            const errorText = await metadataResponse.text();
            console.error('‚ùå Error respuesta metadata:', errorText);
            throw new Error(`Error API: ${metadataResponse.status} - ${metadataResponse.statusText}\n\nVerifica:\n1. SPREADSHEET_ID correcto\n2. Google Sheet p√∫blico\n3. API_KEY v√°lida`);
        }
        
        const metadata = await metadataResponse.json();
        const sheets = metadata.sheets || [];
        const sheetNames = sheets.map(sheet => sheet.properties.title);
        
        console.log('üìä Hojas encontradas:', sheetNames);
        
        // 10 agencias esperadas
        const expectedAgencies = [
            'Honda Cuajimalpa', 'Honda Interlomas', 'KIA Interlomas', 'KIA Iztapalapa', 
            'MG Cuajimalpa', 'MG Interlomas', 'MG Iztapalapa', 'GWM Iztapalapa', 'GWM Morelos',
            'Acura Interlomas'
        ];
        
        // Buscar hojas v√°lidas (m√°s flexible)
        const validSheets = sheetNames.filter(name => {
            const nameLower = name.toLowerCase();
            return expectedAgencies.some(agency => {
                const agencyLower = agency.toLowerCase();
                return nameLower === agencyLower || 
                       nameLower.includes(agencyLower.split(' ')[0]) ||
                       agencyLower.includes(nameLower);
            });
        });
        
        // Si no encuentra las exactas, usar todas las hojas
        if (validSheets.length === 0) {
            console.log('‚ö†Ô∏è No se encontraron hojas espec√≠ficas, usando todas las hojas disponibles');
            validSheets.push(...sheetNames.filter(name => name && name.trim() !== ''));
        }
        
        console.log('‚úÖ Hojas v√°lidas seleccionadas:', validSheets);
        
        if (validSheets.length === 0) {
            throw new Error(`No se encontraron hojas v√°lidas.\nHojas disponibles: ${sheetNames.join(', ')}\nEsperadas: ${expectedAgencies.join(', ')}`);
        }
        
        // Procesar cada hoja
        const loadedAgencies = [];
        const errors = [];
        const successes = [];
        
        for (const sheetName of validSheets) {
            try {
                console.log(`üìã Procesando hoja: ${sheetName}`);
                
                const range = `${sheetName}!A:Z`;
                const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
                
                console.log(`üì° Consultando datos: ${dataUrl}`);
                
                const dataResponse = await fetch(dataUrl);
                if (!dataResponse.ok) {
                    const errorText = await dataResponse.text();
                    console.error(`‚ùå Error en hoja ${sheetName}:`, errorText);
                    errors.push(`${sheetName}: Error ${dataResponse.status}`);
                    continue;
                }
                
                const sheetData = await dataResponse.json();
                
                if (!sheetData.values || sheetData.values.length < 2) {
                    errors.push(`${sheetName}: Sin datos suficientes (${sheetData.values?.length || 0} filas)`);
                    continue;
                }
                
                console.log(`üìä Datos obtenidos para ${sheetName}:`, sheetData.values.length, 'filas');
                
                // Procesar datos reales
                const processedData = processRealSheetData(sheetData.values, sheetName);
                if (processedData && processedData.kpis.length > 0) {
                    loadedAgencies.push(processedData);
                    successes.push(`‚úÖ ${sheetName}: ${processedData.kpis.length} KPIs cargados`);
                    console.log(`‚úÖ ${sheetName} procesada exitosamente`);
                } else {
                    errors.push(`${sheetName}: Error procesando KPIs (datos vac√≠os)`);
                    console.log(`‚ùå ${sheetName} fall√≥ en procesamiento`);
                }
                
            } catch (error) {
                console.error(`‚ùå Error procesando ${sheetName}:`, error);
                errors.push(`${sheetName}: ${error.message}`);
            }
        }
        
        // Mostrar resultados detallados
        console.log('üìä Resumen de carga:');
        console.log('‚úÖ Exitosas:', successes);
        console.log('‚ùå Errores:', errors);
        
        if (loadedAgencies.length > 0) {
            loadedData = loadedAgencies;
            displayResults(loadedAgencies);
            showStatus('success', `Datos REALES cargados: ${loadedAgencies.length} agencias desde Google Sheets`);
            
            // Mostrar detalles en alert
            const alertMessage = `üéâ ¬°CONEXI√ìN API EXITOSA!\n\nüìä Agencias de Autos Nuevos cargadas:\n${successes.join('\n')}\n\n‚úÖ ${loadedAgencies.length} agencias conectadas con datos REALES`;
            
            if (errors.length > 0) {
                alertMessage += `\n\n‚ö†Ô∏è Algunas hojas tuvieron errores:\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? '\n...' : ''}`;
            }
            
            alert(alertMessage);
        } else {
            throw new Error(`No se pudieron cargar datos reales.\n\nErrores encontrados:\n${errors.join('\n')}\n\nVerifica:\n1. Formato de datos en las hojas\n2. Nombres de columnas\n3. Datos num√©ricos v√°lidos`);
        }
        
    } catch (error) {
        console.error('‚ùå Error completo en API:', error);
        showStatus('error', `Error API: ${error.message}`);
        
        // Mensaje de error m√°s √∫til
        let errorMessage = `‚ùå Error conectando con Google Sheets:\n${error.message}`;
        
        if (error.message.includes('SPREADSHEET_ID')) {
            errorMessage += '\n\nüí° Tip: Abre tu Google Sheet y copia el ID de la URL';
        } else if (error.message.includes('403') || error.message.includes('404')) {
            errorMessage += '\n\nüí° Tip: Aseg√∫rate de que el Google Sheet sea p√∫blico';
        }
        
        errorMessage += '\n\n¬øQuieres cargar datos de demostraci√≥n en su lugar?';
        
        const loadDemoOption = confirm(errorMessage);
        if (loadDemoOption) {
            loadDemo();
        }
    }
}

// Funci√≥n para procesar datos reales del Google Sheets
function processRealSheetData(values, agencyName) {
    try {
        if (!values || values.length < 2) {
            throw new Error('Datos insuficientes en la hoja');
        }
        
        console.log(`üìä Procesando ${agencyName}:`, values.length, 'filas');
        
        const headers = values[0];
        const rows = values.slice(1);
        
        console.log(`üîç Headers encontrados:`, headers);
        
        // Buscar columna de KPI (m√°s flexible)
        let kpiColumnIndex = -1;
        
        // Intentar encontrar columna de KPI
        for (let i = 0; i < headers.length; i++) {
            const header = headers[i];
            if (header && typeof header === 'string') {
                const headerLower = header.toLowerCase().trim();
                if (headerLower.includes('kpi') || 
                    headerLower.includes('indicador') ||
                    headerLower.includes('metrica') ||
                    headerLower.includes('nombre') ||
                    headerLower.includes('concepto') ||
                    headerLower === 'a' ||
                    i === 0) { // Si es la primera columna
                    kpiColumnIndex = i;
                    break;
                }
            }
        }
        
        // Si no encuentra, usar la primera columna
        if (kpiColumnIndex === -1) {
            kpiColumnIndex = 0;
            console.log('‚ö†Ô∏è Usando primera columna como KPI');
        }
        
        console.log(`üìã Columna KPI encontrada en √≠ndice: ${kpiColumnIndex}`);
        
        // Buscar columnas de meses (m√°s flexible)
        const monthColumns = [];
        const monthNames = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                          'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        const monthShort = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 
                           'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
        const monthNumbers = ['01', '02', '03', '04', '05', '06', 
                             '07', '08', '09', '10', '11', '12'];
        
        headers.forEach((header, index) => {
            if (header && typeof header === 'string' && index !== kpiColumnIndex) {
                const headerLower = header.toLowerCase().trim();
                
                // Buscar mes completo
                let monthMatch = monthNames.find(month => headerLower.includes(month));
                if (monthMatch) {
                    monthColumns.push({
                        index: index,
                        month: monthMatch.charAt(0).toUpperCase() + monthMatch.slice(1),
                        originalHeader: header
                    });
                    return;
                }
                
                // Buscar mes abreviado
                monthMatch = monthShort.find((month, idx) => headerLower.includes(month) ? monthNames[idx] : null);
                if (monthMatch) {
                    const fullMonth = monthNames[monthShort.indexOf(monthMatch)];
                    monthColumns.push({
                        index: index,
                        month: fullMonth.charAt(0).toUpperCase() + fullMonth.slice(1),
                        originalHeader: header
                    });
                    return;
                }
                
                // Buscar n√∫meros de mes
                monthNumbers.forEach((num, idx) => {
                    if (headerLower.includes(num) || headerLower.includes((idx + 1).toString())) {
                        monthColumns.push({
                            index: index,
                            month: monthNames[idx].charAt(0).toUpperCase() + monthNames[idx].slice(1),
                            originalHeader: header
                        });
                    }
                });
            }
        });
        
        // Si no encuentra meses, usar todas las columnas despu√©s de la primera
        if (monthColumns.length === 0) {
            console.log('‚ö†Ô∏è No se encontraron meses espec√≠ficos, usando todas las columnas num√©ricas');
            for (let i = kpiColumnIndex + 1; i < headers.length; i++) {
                if (headers[i]) {
                    monthColumns.push({
                        index: i,
                        month: headers[i].toString().trim() || `Columna_${i}`,
                        originalHeader: headers[i]
                    });
                }
            }
        }
        
        console.log(`üìÖ Columnas de meses encontradas:`, monthColumns);
        
        if (monthColumns.length === 0) {
            throw new Error('No se encontraron columnas de datos');
        }
        
        // Funci√≥n para convertir valores
        function parseValue(value) {
            if (value === null || value === undefined || value === '') {
                return 0;
            }
            
            // Si ya es un n√∫mero
            if (typeof value === 'number') {
                return isNaN(value) ? 0 : value;
            }
            
            // Si es string, limpiar y convertir
            if (typeof value === 'string') {
                // Remover espacios, comas, s√≠mbolos de moneda
                let cleanValue = value.toString()
                    .replace(/[\s,\$‚Ç¨¬£¬•‚Çπ]/g, '')
                    .replace(/[()]/g, '')
                    .trim();
                
                // Si est√° vac√≠o despu√©s de limpiar
                if (cleanValue === '' || cleanValue === '-') {
                    return 0;
                }
                
                // Intentar convertir a n√∫mero
                const numValue = parseFloat(cleanValue);
                return isNaN(numValue) ? 0 : numValue;
            }
            
            return 0;
        }
        
        // Procesar KPIs
        const kpis = [];
        const availableMonths = monthColumns.map(col => col.month);
        
        console.log(`üîÑ Procesando ${rows.length} filas de datos...`);
        
        rows.forEach((row, rowIndex) => {
            if (!row || row.length === 0) return;
            
            const kpiName = row[kpiColumnIndex];
            if (kpiName && kpiName.toString().trim()) {
                const kpi = { name: kpiName.toString().trim() };
                
                monthColumns.forEach(monthCol => {
                    const rawValue = row[monthCol.index];
                    const parsedValue = parseValue(rawValue);
                    kpi[monthCol.month] = parsedValue;
                    
                    // Log para debugging
                    if (kpiName.toLowerCase().includes('utilidad') && parsedValue !== 0) {
                        console.log(`üí∞ ${kpiName} - ${monthCol.month}: ${rawValue} ‚Üí ${parsedValue}`);
                    }
                });
                
                kpis.push(kpi);
            }
        });
        
        console.log(`‚úÖ ${agencyName} procesada: ${kpis.length} KPIs`);
        
        // Debug: mostrar algunos KPIs procesados
        const sampleKpis = kpis.slice(0, 3);
        console.log(`üìã Muestra de KPIs procesados:`, sampleKpis);
        
        return {
            agency: agencyName,
            kpis: kpis,
            months: availableMonths
        };
        
    } catch (error) {
        console.error(`‚ùå Error procesando ${agencyName}:`, error);
        return null;
    }
}

// Funci√≥n para mostrar estado
function showStatus(type, message) {
    const statusDiv = document.getElementById('status');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    
    statusDiv.classList.remove('hidden');
    statusText.textContent = message;
    
    // Limpiar clases previas
    statusDiv.className = statusDiv.className.replace(/border-\w+-500/g, '');
    statusIcon.className = statusIcon.className.replace(/text-\w+-500/g, '').replace(/fas fa-\w+/g, '');
    
    switch(type) {
        case 'loading':
            statusDiv.classList.add('border-blue-500');
            statusIcon.classList.add('fas', 'fa-spinner', 'fa-spin', 'text-blue-500');
            break;
        case 'success':
            statusDiv.classList.add('border-green-500');
            statusIcon.classList.add('fas', 'fa-check-circle', 'text-green-500');
            break;
        case 'error':
            statusDiv.classList.add('border-red-500');
            statusIcon.classList.add('fas', 'fa-exclamation-triangle', 'text-red-500');
            break;
    }
}

// Funci√≥n para mostrar resultados
function displayResults(data) {
    console.log('üìä Mostrando resultados para', data.length, 'agencias');
    
    // Mostrar secci√≥n de resultados
    document.getElementById('results').classList.remove('hidden');
    
    // Recopilar informaci√≥n
    allKPIs = [...new Set(data.flatMap(agency => agency.kpis.map(kpi => kpi.name)))];
    allMonths = [...new Set(data.flatMap(agency => agency.months))];
    
    // Actualizar estad√≠sticas
    document.getElementById('totalKPIs').textContent = allKPIs.length;
    document.getElementById('totalAgencies').textContent = data.length;
    document.getElementById('totalPeriods').textContent = allMonths.length;
    
    // Mostrar lista de agencias
    displayAgenciesList(data);
    
    // Inicializar controles
    initializeControls();
    
    // Seleccionar todas las agencias y meses por defecto
    selectedAgencies = data.map(agency => agency.agency);
    selectedMonths = [...allMonths];
    
    // Actualizar an√°lisis inicial
    updateAnalysis();
}

// Funci√≥n para mostrar lista de agencias
function displayAgenciesList(data) {
    const agenciesListDiv = document.getElementById('agenciesList');
    
    agenciesListDiv.innerHTML = data.map(agency => `
        <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/10">
            <div class="flex items-center space-x-3">
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <div>
                    <h4 class="text-white font-semibold">${agency.agency}</h4>
                    <p class="text-gray-400 text-sm">${agency.kpis.length} KPIs ‚Ä¢ ${agency.months.length} meses</p>
                </div>
            </div>
            <i class="fas fa-check-circle text-green-500"></i>
        </div>
    `).join('');
}

// Funci√≥n para inicializar controles
function initializeControls() {
    // Checkboxes de agencias
    const agencyCheckboxesDiv = document.getElementById('agencyCheckboxes');
    agencyCheckboxesDiv.innerHTML = loadedData.map(agency => `
        <label class="flex items-center space-x-3 text-white hover:bg-white/5 p-2 rounded-lg transition-all cursor-pointer">
            <input type="checkbox" value="${agency.agency}" onchange="updateAgencySelection()" 
                   class="w-4 h-4 text-blue-500 bg-white/10 border-white/30 rounded focus:ring-blue-500 focus:ring-2" checked>
            <span>${agency.agency}</span>
        </label>
    `).join('');
    
    // Checkboxes de meses
    const monthCheckboxesDiv = document.getElementById('monthCheckboxes');
    monthCheckboxesDiv.innerHTML = allMonths.map(month => `
        <label class="flex items-center space-x-3 text-white hover:bg-white/5 p-2 rounded-lg transition-all cursor-pointer">
            <input type="checkbox" value="${month}" onchange="updateMonthSelection()" 
                   class="w-4 h-4 text-green-500 bg-white/10 border-white/30 rounded focus:ring-green-500 focus:ring-2" checked>
            <span>${month}</span>
        </label>
    `).join('');
    
    // Inicializar selector de agencia individual
    const singleAgencySelect = document.getElementById('singleAgencySelect');
    singleAgencySelect.innerHTML = '<option value="">Selecciona una agencia...</option>' +
        loadedData.map(agency => `<option value="${agency.agency}">${agency.agency}</option>`).join('');
    
    updateCounts();
}

// Funci√≥n para actualizar contadores
function updateCounts() {
    document.getElementById('agencyCount').textContent = `Agencias (${selectedAgencies.length}/${loadedData.length})`;
    document.getElementById('monthCount').textContent = `Meses (${selectedMonths.length})`;
}

// Funci√≥n para actualizar selecci√≥n de agencias
function updateAgencySelection() {
    const checkboxes = document.querySelectorAll('#agencyCheckboxes input[type="checkbox"]');
    selectedAgencies = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    updateCounts();
}

// Funci√≥n para actualizar selecci√≥n de meses
function updateMonthSelection() {
    const checkboxes = document.querySelectorAll('#monthCheckboxes input[type="checkbox"]');
    selectedMonths = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    updateCounts();
}

// Funci√≥n para seleccionar todas las agencias
function selectAllAgencies() {
    const checkboxes = document.querySelectorAll('#agencyCheckboxes input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateAgencySelection();
}

// Funci√≥n para deseleccionar todas las agencias
function deselectAllAgencies() {
    const checkboxes = document.querySelectorAll('#agencyCheckboxes input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateAgencySelection();
}

// Funci√≥n para actualizar an√°lisis
function updateAnalysis() {
    console.log('üîÑ Actualizando an√°lisis...');
    
    if (selectedAgencies.length === 0) {
        alert('Por favor selecciona al menos una agencia');
        return;
    }
    
    if (selectedMonths.length === 0) {
        alert('Por favor selecciona al menos un mes');
        return;
    }
    
    generateMainTable();
    
    showStatus('success', `An√°lisis actualizado: ${selectedAgencies.length} agencias, ${selectedMonths.length} meses`);
}

// Funci√≥n para generar tabla principal
function generateMainTable() {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    // Filtrar datos seleccionados
    const filteredData = loadedData.filter(agency => selectedAgencies.includes(agency.agency));
    
    // Crear encabezados
    const headers = ['KPI', ...selectedAgencies];
    tableHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join('');
    
    // Crear filas
    const rows = [];
    allKPIs.forEach(kpiName => {
        const row = [kpiName];
        const rowValues = []; // Para encontrar el valor m√°s alto
        
        selectedAgencies.forEach(agencyName => {
            const agency = filteredData.find(a => a.agency === agencyName);
            if (agency) {
                const kpi = agency.kpis.find(k => k.name === kpiName);
                if (kpi) {
                    // Calcular promedio de los meses seleccionados
                    const values = selectedMonths.map(month => kpi[month] || 0);
                    const average = values.reduce((sum, val) => sum + val, 0) / values.length;
                    const roundedAverage = Math.round(average);
                    row.push(roundedAverage);
                    rowValues.push(roundedAverage);
                } else {
                    row.push('N/A');
                    rowValues.push('N/A');
                }
            } else {
                row.push('N/A');
                rowValues.push('N/A');
            }
        });
        
        // Encontrar el valor m√°s alto de esta fila
        const highestValue = findHighestValue(rowValues);
        
        rows.push({ data: row, rowValues: rowValues, highest: highestValue });
    });
    
    // Renderizar filas con formateo y resaltado
    tableBody.innerHTML = rows.map(rowObj => {
        const formattedCells = rowObj.data.map((cell, index) => {
            if (index === 0) {
                // Primera columna (KPI name)
                return `<td>${cell}</td>`;
            } else {
                // Columnas de datos
                const rawValue = rowObj.rowValues[index - 1];
                const isHighest = rawValue !== 'N/A' && rawValue === rowObj.highest && rowObj.highest !== null;
                const formattedValue = formatNumber(cell);
                const cssClass = isHighest ? 'highest-value' : '';
                
                return `<td class="${cssClass}">${formattedValue}</td>`;
            }
        }).join('');
        
        return `<tr>${formattedCells}</tr>`;
    }).join('');
}

// Funci√≥n para refrescar datos
function refreshData() {
    if (loadedData.length > 0) {
        showStatus('loading', 'Refrescando datos...');
        setTimeout(() => {
            updateAnalysis();
            showStatus('success', 'Datos refrescados correctamente');
        }, 1000);
    } else {
        alert('No hay datos cargados para refrescar');
    }
}

// Funci√≥n para actualizar meses de agencia individual
function updateSingleAgencyMonths() {
    const selectedAgency = document.getElementById('singleAgencySelect').value;
    const singleMonthCheckboxes = document.getElementById('singleMonthCheckboxes');
    const singleMonthCount = document.getElementById('singleMonthCount');
    
    if (!selectedAgency) {
        singleMonthCheckboxes.innerHTML = '<p class="text-gray-400 text-sm">Primero selecciona una agencia</p>';
        singleMonthCount.textContent = 'Meses (0)';
        return;
    }
    
    singleSelectedAgency = selectedAgency;
    const agency = loadedData.find(a => a.agency === selectedAgency);
    
    if (agency) {
        singleMonthCheckboxes.innerHTML = agency.months.map(month => `
            <label class="flex items-center space-x-3 text-white hover:bg-white/5 p-2 rounded-lg transition-all cursor-pointer">
                <input type="checkbox" value="${month}" onchange="updateSingleMonthSelection()" 
                       class="w-4 h-4 text-green-500 bg-white/10 border-white/30 rounded focus:ring-green-500 focus:ring-2">
                <span>${month}</span>
            </label>
        `).join('');
        
        singleSelectedMonths = [];
        updateSingleMonthCount();
    }
}

// Funci√≥n para actualizar selecci√≥n de meses individuales
function updateSingleMonthSelection() {
    const checkboxes = document.querySelectorAll('#singleMonthCheckboxes input[type="checkbox"]');
    singleSelectedMonths = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    updateSingleMonthCount();
}

// Funci√≥n para actualizar contador de meses individuales
function updateSingleMonthCount() {
    document.getElementById('singleMonthCount').textContent = `Meses (${singleSelectedMonths.length})`;
}

// Funci√≥n para generar tabla de agencia individual
function generateSingleAgencyTable() {
    if (!singleSelectedAgency) {
        alert('Por favor selecciona una agencia');
        return;
    }
    
    if (singleSelectedMonths.length === 0) {
        alert('Por favor selecciona al menos un mes');
        return;
    }
    
    const agency = loadedData.find(a => a.agency === singleSelectedAgency);
    if (!agency) {
        alert('Agencia no encontrada');
        return;
    }
    
    const singleTableHeader = document.getElementById('singleTableHeader');
    const singleTableBody = document.getElementById('singleTableBody');
    const container = document.getElementById('singleAgencyTableContainer');
    
    // Mostrar container
    container.classList.remove('hidden');
    
    // Crear encabezados - SOLO AGREGAR PROMEDIO Y TENDENCIA
    const headers = ['KPI', ...singleSelectedMonths, 'Promedio', 'Tendencia'];
    singleTableHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join('');
    
    // Crear filas con formateo y resaltado
    const rows = agency.kpis.map(kpi => {
        const row = [kpi.name];
        const rowValues = [];
        
        singleSelectedMonths.forEach(month => {
            const value = kpi[month];
            row.push(value);
            rowValues.push(value);
        });
        
        // CALCULAR PROMEDIO
        const validValues = rowValues.filter(val => val !== null && val !== undefined && val !== 'N/A' && !isNaN(val));
        const average = validValues.length > 0 ? validValues.reduce((sum, val) => sum + val, 0) / validValues.length : 0;
        
        // CALCULAR TENDENCIA SIMPLE
        let trend = 'Sin datos';
        let trendColor = 'text-gray-400';
        let trendIcon = 'fas fa-minus';
        
        if (validValues.length >= 2) {
            const firstValue = validValues[0];
            const lastValue = validValues[validValues.length - 1];
            const percentChange = ((lastValue - firstValue) / firstValue) * 100;
            
            if (Math.abs(percentChange) < 5) {
                trend = 'Estable';
                trendColor = 'text-blue-400';
                trendIcon = 'fas fa-equals';
            } else if (percentChange > 0) {
                trend = `‚Üó +${percentChange.toFixed(1)}%`;
                trendColor = 'text-green-500';
                trendIcon = 'fas fa-arrow-up';
            } else {
                trend = `‚Üò ${percentChange.toFixed(1)}%`;
                trendColor = 'text-red-500';
                trendIcon = 'fas fa-arrow-down';
            }
        }
        
        // Encontrar el valor m√°s alto de esta fila
        const highestValue = findHighestValue(rowValues);
        
        return { data: row, rowValues: rowValues, highest: highestValue, average: average, trend: trend, trendColor: trendColor, trendIcon: trendIcon };
    });
    
    // Renderizar filas con formateo y resaltado
    singleTableBody.innerHTML = rows.map(rowObj => {
        const formattedCells = rowObj.data.map((cell, index) => {
            if (index === 0) {
                // Primera columna (KPI name)
                return `<td>${cell}</td>`;
            } else if (index === rowObj.data.length - 2) {
                // Esta es la posici√≥n del promedio (pen√∫ltima columna)
                const formattedAverage = formatNumber(rowObj.average);
                return `<td class="font-semibold text-yellow-400">${formattedAverage}</td>`;
            } else if (index === rowObj.data.length - 1) {
                // Esta es la posici√≥n de la tendencia (√∫ltima columna)
                return `<td class="${rowObj.trendColor}"><i class="${rowObj.trendIcon} mr-2"></i>${rowObj.trend}</td>`;
            } else {
                // Columnas de datos de meses
                const rawValue = rowObj.rowValues[index - 1];
                const isHighest = rawValue !== 'N/A' && rawValue === rowObj.highest && rowObj.highest !== null;
                const formattedValue = formatNumber(cell);
                const cssClass = isHighest ? 'highest-value' : '';
                
                return `<td class="${cssClass}">${formattedValue}</td>`;
            }
        }).join('');
        
        return `<tr>${formattedCells}</tr>`;
    }).join('');
    
    showStatus('success', `Tabla individual generada para ${singleSelectedAgency}`);
}

// Funci√≥n para exportar tabla principal a Excel
function exportMainTableToExcel() {
    if (selectedAgencies.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    try {
        // Obtener datos de la tabla
        const headers = ['KPI', ...selectedAgencies];
        const data = [headers];
        
        // Agregar filas de datos
        allKPIs.forEach(kpiName => {
            const row = [kpiName];
            
            selectedAgencies.forEach(agencyName => {
                const agency = loadedData.find(a => a.agency === agencyName);
                if (agency) {
                    const kpi = agency.kpis.find(k => k.name === kpiName);
                    if (kpi) {
                        const values = selectedMonths.map(month => kpi[month] || 0);
                        const average = values.reduce((sum, val) => sum + val, 0) / values.length;
                        row.push(Math.round(average));
                    } else {
                        row.push('N/A');
                    }
                } else {
                    row.push('N/A');
                }
            });
            
            data.push(row);
        });
        
        // Crear workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Agregar worksheet
        XLSX.utils.book_append_sheet(wb, ws, 'An√°lisis KPIs');
        
        // Descargar archivo
        const filename = `KPIs_Autos_Nuevos_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        showStatus('success', 'Archivo Excel exportado correctamente');
        
    } catch (error) {
        console.error('Error exportando Excel:', error);
        alert('Error al exportar archivo Excel');
    }
}

// Funci√≥n para exportar tabla individual a Excel
function exportSingleTableToExcel() {
    if (!singleSelectedAgency || singleSelectedMonths.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    try {
        const agency = loadedData.find(a => a.agency === singleSelectedAgency);
        
        // Obtener datos de la tabla - INCLUIR PROMEDIO Y TENDENCIA
        const headers = ['KPI', ...singleSelectedMonths, 'Promedio', 'Tendencia'];
        const data = [headers];
        
        // Agregar filas de datos
        agency.kpis.forEach(kpi => {
            const row = [kpi.name];
            const rowValues = [];
            
            singleSelectedMonths.forEach(month => {
                const value = kpi[month] || 'N/A';
                row.push(value);
                rowValues.push(value);
            });
            
            // Calcular promedio
            const validValues = rowValues.filter(val => val !== null && val !== undefined && val !== 'N/A' && !isNaN(val));
            const average = validValues.length > 0 ? Math.round(validValues.reduce((sum, val) => sum + val, 0) / validValues.length) : 'N/A';
            
            // Calcular tendencia
            let trend = 'Sin datos';
            if (validValues.length >= 2) {
                const firstValue = validValues[0];
                const lastValue = validValues[validValues.length - 1];
                const percentChange = ((lastValue - firstValue) / firstValue) * 100;
                
                if (Math.abs(percentChange) < 5) {
                    trend = 'Estable';
                } else if (percentChange > 0) {
                    trend = `‚Üó +${percentChange.toFixed(1)}%`;
                } else {
                    trend = `‚Üò ${percentChange.toFixed(1)}%`;
                }
            }
            
            row.push(average);
            row.push(trend);
            
            data.push(row);
        });
        
        // Crear workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Agregar worksheet
        XLSX.utils.book_append_sheet(wb, ws, singleSelectedAgency);
        
        // Descargar archivo
        const filename = `${singleSelectedAgency}_KPIs_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        showStatus('success', 'Archivo Excel exportado correctamente');
        
    } catch (error) {
        console.error('Error exportando Excel:', error);
        alert('Error al exportar archivo Excel');
    }
}

// Inicializaci√≥n del dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéâ Dashboard KPIs Autos Nuevos Daytona cargado correctamente');
});
</script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard KPIs Autos Nuevos - Grupo Daytona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        .animated-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(239, 68, 68, 0.5);
            border-radius: 3px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th, td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            text-align: center;
        }
        
        th {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            color: rgba(255, 255, 255, 0.9);
        }
        
        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .highest-value {
            background: rgba(34, 197, 94, 0.2) !important;
            color: #22c55e !important;
            font-weight: 600;
            border: 1px solid rgba(34, 197, 94, 0.3) !important;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation Bar -->
    <nav class="glass-effect border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://api.grupodaytona.com/files/images/full-xzLxpZqXUE-1728519042236.png" alt="Grupo Daytona" class="w-10 h-10 rounded-lg object-contain bg-white/10 p-1">
                    <div>
                        <h1 class="text-xl font-bold text-white">Grupo Daytona</h1>
                        <p class="text-sm text-gray-300">Dashboard KPIs Autos Nuevos</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="hidden md:flex items-center space-x-2 text-gray-300">
                        <i class="fas fa-clock text-sm"></i>
                        <span class="text-sm" id="currentTime"></span>
                    </div>
                    
                    <!-- Navigation Link -->
                    <a href="https://flozanol.github.io/daytona-seminuevos-kpis/" 
                       target="_blank"
                       class="hidden md:flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg text-white text-sm font-medium hover:from-blue-600 hover:to-purple-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <i class="fas fa-exchange-alt text-sm"></i>
                        <span>Dashboard Seminuevos</span>
                        <i class="fas fa-external-link-alt text-xs"></i>
                    </a>
                    
                    <!-- Mobile Navigation Button -->
                    <button onclick="window.open('https://flozanol.github.io/daytona-seminuevos-kpis/', '_blank')"
                            class="md:hidden flex items-center justify-center w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg text-white hover:from-blue-600 hover:to-purple-600 transition-all duration-300 shadow-lg">
                        <i class="fas fa-exchange-alt text-sm"></i>
                    </button>
                    
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Hero Section -->
        <div class="text-center mb-12">
            <div class="flex items-center justify-center mb-4">
                <div class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full text-white text-sm font-semibold mr-4">
                    <i class="fas fa-car mr-2"></i>
                    AUTOS NUEVOS
                </div>
                <div class="text-gray-400 text-sm">
                    <a href="https://flozanol.github.io/daytona-seminuevos-kpis/" 
                       target="_blank" 
                       class="hover:text-blue-400 transition-colors flex items-center">
                        <i class="fas fa-exchange-alt mr-1"></i>
                        Ver Dashboard Seminuevos
                    </a>
                </div>
            </div>
            <h2 class="text-5xl font-bold gradient-text mb-4">
                Dashboard KPIs Autos Nuevos Daytona
            </h2>
            <p class="text-xl text-gray-300 max-w-2xl mx-auto leading-relaxed">
                An√°lisis en tiempo real de indicadores clave de rendimiento para autos nuevos en todas las agencias
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center space-x-6 mb-12">
            <button onclick="loadDemo()" class="btn-primary px-8 py-4 rounded-xl text-white font-semibold text-lg shadow-2xl">
                <i class="fas fa-play mr-3"></i>
                Cargar Demo
            </button>
            <button onclick="connectToAPI()" class="btn-secondary px-8 py-4 rounded-xl text-white font-semibold text-lg shadow-2xl">
                <i class="fas fa-link mr-3 animated-icon"></i>
                Conectar API
            </button>
        </div>

        <!-- Status Bar -->
        <div id="status" class="hidden mb-8">
            <div class="glass-effect rounded-xl p-4 border-l-4">
                <div class="flex items-center">
                    <i id="statusIcon" class="text-2xl mr-3"></i>
                    <p id="statusText" class="text-lg font-medium text-white"></p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <!-- KPI Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-red-500 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-chart-bar text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalKPIs">0</h3>
                    <p class="text-gray-300 font-medium">Total KPIs</p>
                </div>
                
                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-building text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalAgencies">10</h3>
                    <p class="text-gray-300 font-medium">Agencias Activas</p>
                </div>
                
                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-calendar text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalPeriods">0</h3>
                    <p class="text-gray-300 font-medium">Per√≠odos Seleccionados</p>
                </div>
            </div>

            <!-- Agencies Overview -->
            <div class="glass-effect rounded-2xl p-8 mb-8 card-hover">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-store text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-white">Agencias Conectadas</h3>
                        <p class="text-gray-300">Estado de conexi√≥n de las agencias</p>
                    </div>
                </div>
                <div id="agenciesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            
            <!-- Controls Panel -->
            <div class="glass-effect rounded-2xl p-8 mb-8 card-hover">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-sliders-h text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-white">Configuraci√≥n del An√°lisis</h3>
                        <p class="text-gray-300">Personaliza tu comparaci√≥n</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Agency Selection -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-lg font-semibold text-white flex items-center">
                                <i class="fas fa-building mr-2 text-blue-400"></i>
                                <span id="agencyCount">Agencias (0/10)</span>
                            </label>
                            <div class="space-x-2">
                                <button onclick="selectAllAgencies()" class="px-3 py-1 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30 transition-all">
                                    Todas
                                </button>
                                <button onclick="deselectAllAgencies()" class="px-3 py-1 bg-red-500/20 text-red-400 rounded-lg text-sm hover:bg-red-500/30 transition-all">
                                    Ninguna
                                </button>
                            </div>
                        </div>
                        <div class="max-h-64 overflow-y-auto bg-white/5 border border-white/10 rounded-xl p-4 scrollbar-thin">
                            <div id="agencyCheckboxes" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- Month Selection -->
                    <div class="space-y-4">
                        <label class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-green-400"></i>
                            <span id="monthCount">Meses (0)</span>
                        </label>
                        <div class="max-h-64 overflow-y-auto bg-white/5 border border-white/10 rounded-xl p-4 scrollbar-thin">
                            <div id="monthCheckboxes" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 mt-8">
                    <button onclick="updateAnalysis()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualizar An√°lisis
                    </button>
                    <button onclick="refreshData()" class="px-6 py-3 bg-blue-500/20 text-blue-400 rounded-xl font-semibold hover:bg-blue-500/30 transition-all">
                        <i class="fas fa-refresh mr-2"></i>
                        Refrescar Datos
                    </button>
                </div>
            </div>
            
            <!-- KPI Analysis Table -->
            <div class="glass-effect rounded-2xl p-8 card-hover mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-table text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">An√°lisis Detallado de KPIs</h3>
                            <p class="text-gray-300">Vista completa de todos los indicadores</p>
                        </div>
                    </div>
                    <button onclick="exportMainTableToExcel()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30 transition-all flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>
                        Exportar a Excel
                    </button>
                </div>
                
                <div class="overflow-auto max-h-96 bg-white/5 border border-white/10 rounded-xl scrollbar-thin">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-white/10"></tbody>
                    </table>
                </div>
            </div>

            <!-- An√°lisis Individual de Agencia -->
            <div class="glass-effect rounded-2xl p-8 card-hover mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-yellow-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-chart-pie text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">An√°lisis Individual por Agencia</h3>
                            <p class="text-gray-300">Comparaci√≥n mensual de una agencia espec√≠fica</p>
                        </div>
                    </div>
                    <button onclick="exportSingleTableToExcel()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30 transition-all flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>
                        Exportar a Excel
                    </button>
                </div>

                <!-- Controles -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Selector de Agencia -->
                    <div class="space-y-4">
                        <label class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-building mr-2 text-orange-400"></i>
                            Seleccionar Agencia
                        </label>
                        <select id="singleAgencySelect" onchange="updateSingleAgencyMonths()" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option value="">Selecciona una agencia...</option>
                        </select>
                    </div>

                    <!-- Selector de Meses -->
                    <div class="space-y-4">
                        <label class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-green-400"></i>
                            <span id="singleMonthCount">Meses (0)</span>
                        </label>
                        <div class="max-h-64 overflow-y-auto bg-white/5 border border-white/10 rounded-xl p-4 scrollbar-thin">
                            <div id="singleMonthCheckboxes" class="space-y-2">
                                <p class="text-gray-400 text-sm">Primero selecciona una agencia</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n Generar -->
                <div class="flex justify-center mb-8">
                    <button onclick="generateSingleAgencyTable()" class="btn-primary px-8 py-3 rounded-xl text-white font-semibold text-lg">
                        <i class="fas fa-chart-bar mr-3"></i>
                        Generar An√°lisis Individual
                    </button>
                </div>

                <!-- Tabla Individual -->
                <div id="singleAgencyTableContainer" class="hidden">
                    <div class="overflow-auto max-h-96 bg-white/5 border border-white/10 rounded-xl scrollbar-thin">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr id="singleTableHeader"></tr>
                            </thead>
                            <tbody id="singleTableBody" class="divide-y divide-white/10"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-16 text-center">
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex items-center justify-center space-x-6 text-gray-300">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-shield-alt text-green-400"></i>
                        <span>Datos Seguros</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-sync text-blue-400"></i>
                        <span>Tiempo Real</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-chart-line text-red-400"></i>
                        <span>Analytics Avanzados</span>
                    </div>
                </div>
                <p class="text-gray-400 text-sm mt-4">
                    ¬© 2025 Grupo Daytona - Dashboard KPIs Autos Nuevos
                </p>
            </div>
        </footer>
    </div>

<script>
// Variables globales
let loadedData = [];
let selectedAgencies = [];
let selectedMonths = [];
let allKPIs = [];
let allMonths = [];
let singleSelectedAgency = '';
let singleSelectedMonths = [];

// API Configuration - CONFIGURADO CON TU SPREADSHEET_ID
const API_KEY = "AIzaSyATBI8jMV1AtfsjhmwEwfOMYSdKmhMM5ck";
const SPREADSHEET_ID = "1xzQYs3KOIINVTTvVOYSQDiuiQDUsCWwqEDoQAUvBNfQ";

console.log('üöÄ Dashboard Autos Nuevos iniciado');

// Funci√≥n para formatear n√∫meros con comas
function formatNumber(value) {
    if (value === null || value === undefined || value === 'N/A') {
        return 'N/A';
    }
    
    // Convertir a n√∫mero si es string
    const num = typeof value === 'string' ? parseFloat(value) : value;
    
    if (isNaN(num)) {
        return 'N/A';
    }
    
    // Formatear con comas como separador de miles
    return num.toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
}

// Funci√≥n para encontrar el valor m√°s alto en una fila (excluyendo N/A)
function findHighestValue(values) {
    const numericValues = values
        .filter(val => val !== 'N/A' && !isNaN(val) && val !== null && val !== undefined)
        .map(val => typeof val === 'string' ? parseFloat(val) : val);
    
    if (numericValues.length === 0) return null;
    return Math.max(...numericValues);
}

// Actualizar reloj
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const clockElement = document.getElementById('currentTime');
    if (clockElement) {
        clockElement.textContent = timeString;
    }
}
setInterval(updateClock, 1000);
updateClock();

// FUNCI√ìN PRINCIPAL: Cargar Demo
function loadDemo() {
    console.log('üéØ Cargando demo de autos nuevos...');
    
    showStatus('loading', 'Cargando datos de demostraci√≥n...');
    
    // KPIs espec√≠ficos para autos nuevos
    const kpis = [
        'Ventas Nuevos', 'Leads Nuevos', 'Test Drive Nuevos', 'Conversi√≥n % Nuevos', 'Financiamientos Nuevos',
        'Seguros Nuevos', 'Cotizaciones Nuevos', 'Seguimientos Nuevos', 'Llamadas Nuevos', 'Satisfacci√≥n Nuevos',
        'Tiempo Entrega', 'Post-Venta Nuevos', 'Garant√≠as Nuevos', 'Accesorios Nuevos', 'Cross-Selling Nuevos',
        'Up-Selling Nuevos', 'Referidos Nuevos', 'ROI Marketing Nuevos', 'Costo Lead Nuevos', 'Valor Cliente Nuevos',
        'Inventario Nuevos', 'Rotaci√≥n Stock', 'Tr√°fico Showroom Nuevos', 'Conversi√≥n Digital Nuevos', 'Social Media Nuevos',
        'Email Marketing Nuevos', 'WhatsApp Nuevos', 'Devoluciones Nuevos', 'Quejas Nuevos', 'NPS Nuevos',
        'Retenci√≥n Nuevos', 'Recompras Nuevos', 'Churn Rate Nuevos', 'Metas Cumplidas Nuevos', 'Capacitaci√≥n Nuevos'
    ];
    
    // 10 agencias (incluye Acura Interlomas)
    const agencies = [
        { name: 'Honda Cuajimalpa', base: 220 },
        { name: 'Honda Interlomas', base: 200 },
        { name: 'KIA Interlomas', base: 180 },
        { name: 'KIA Iztapalapa', base: 160 },
        { name: 'MG Cuajimalpa', base: 140 },
        { name: 'MG Interlomas', base: 120 },
        { name: 'MG Iztapalapa', base: 110 },
        { name: 'GWM Iztapalapa', base: 100 },
        { name: 'GWM Morelos', base: 80 },
        { name: 'Acura Interlomas', base: 250 }
    ];

    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    // Generar datos
    const data = agencies.map(agency => {
        const agencyKPIs = kpis.map(kpiName => {
            const kpi = { name: kpiName };
            months.forEach(month => {
                const variation = (Math.random() - 0.5) * 0.4;
                kpi[month] = Math.max(1, Math.round(agency.base * (1 + variation)));
            });
            return kpi;
        });

        return {
            agency: agency.name,
            kpis: agencyKPIs,
            months: months
        };
    });

    console.log('‚úÖ Datos generados:', data.length, 'agencias');
    
    // Guardar y mostrar
    loadedData = data;
    displayResults(data);
    showStatus('success', `Demo cargada: ${data.length} agencias, ${kpis.length} KPIs`);
}

// FUNCI√ìN PRINCIPAL: Conectar API REAL
async function connectToAPI() {
    console.log('üöÄ Conectando con Google Sheets...');
    
    showStatus('loading', 'Conectando con Google Sheets API...');
    
    try {
        // Verificar configuraci√≥n
        if (!SPREADSHEET_ID || SPREADSHEET_ID === "TU_NUEVO_SPREADSHEET_ID_AQUI") {
            throw new Error('‚ö†Ô∏è SPREADSHEET_ID no configurado correctamente');
